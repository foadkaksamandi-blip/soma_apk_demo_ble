// soma_bluetooth_core/lib/main.dart

import 'dart:async';
import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:flutter_blue/flutter_blue.dart';

void main() {
  WidgetsFlutterBinding.ensureInitialized();
  runApp(const SomaBluetoothCoreApp());
}

class SomaBluetoothCoreApp extends StatelessWidget {
  const SomaBluetoothCoreApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Soma Bluetooth Core',
      debugShowCheckedModeBanner: false,
      theme: ThemeData(
        primarySwatch: Colors.teal,
        scaffoldBackgroundColor: Colors.black,
        appBarTheme: const AppBarTheme(
          backgroundColor: Colors.teal,
          foregroundColor: Colors.white,
        ),
        textTheme: const TextTheme(
          bodyMedium: TextStyle(
            fontSize: 14,
            color: Colors.white,
          ),
        ),
      ),
      home: const BluetoothHomePage(),
    );
  }
}

class BluetoothHomePage extends StatefulWidget {
  const BluetoothHomePage({super.key});

  @override
  State<BluetoothHomePage> createState() => _BluetoothHomePageState();
}

class _BluetoothHomePageState extends State<BluetoothHomePage> {
  final FlutterBlue _flutterBlue = FlutterBlue.instance;

  StreamSubscription<ScanResult>? _scanSubscription;
  final List<ScanResult> _scanResults = <ScanResult>[];

  BluetoothDevice? _connectedDevice;
  StreamSubscription<BluetoothDeviceState>? _deviceStateSub;

  BluetoothCharacteristic? _writeCharacteristic;
  String _connectionStateText = 'Disconnected';
  String _log = '';
  bool _isScanning = false;

  @override
  void initState() {
    super.initState();
    _listenBluetoothState();
  }

  @override
  void dispose() {
    _stopScan();
    _disconnectFromDevice();
    super.dispose();
  }

  void _listenBluetoothState() {
    _flutterBlue.state.listen((BluetoothState state) {
      _appendLog('Bluetooth state: $state');
    });
  }

  void _appendLog(String message) {
    setState(() {
      final String time = TimeOfDay.now().format(context);
      _log = '[$time] $message\n$_log';
    });
  }

  Future<void> _startScan() async {
    if (_isScanning) return;

    _scanResults.clear();
    setState(() {
      _isScanning = true;
    });

    _appendLog('Start scanning for BLE devices...');

    _scanSubscription?.cancel();
    _scanSubscription = _flutterBlue.scan(
      timeout: const Duration(seconds: 8),
    ).listen((ScanResult result) {
      final int index = _scanResults.indexWhere(
        (ScanResult r) => r.device.id == result.device.id,
      );
      if (index == -1) {
        setState(() {
          _scanResults.add(result);
        });
      } else {
        setState(() {
          _scanResults[index] = result;
        });
      }
    }, onDone: () {
      setState(() {
        _isScanning = false;
      });
      _appendLog('Scan finished.');
    }, onError: (Object e) {
      setState(() {
        _isScanning = false;
      });
      _appendLog('Scan error: $e');
    });
  }

  Future<void> _stopScan() async {
    if (_isScanning) {
      await _flutterBlue.stopScan();
    }
    await _scanSubscription?.cancel();
    _scanSubscription = null;
    setState(() {
      _isScanning = false;
    });
    _appendLog('Scan stopped.');
  }

  Future<void> _connectToDevice(ScanResult result) async {
    final BluetoothDevice device = result.device;

    await _stopScan();

    _appendLog('Connecting to ${device.name.isEmpty ? device.id.id : device.name} ...');

    try {
      await device.connect(
        timeout: const Duration(seconds: 10),
      );
    } on Exception catch (e) {
      _appendLog('Connect error: $e');
      return;
    }

    _connectedDevice = device;
    _connectionStateText = 'Connecting...';
    setState(() {});

    _deviceStateSub?.cancel();
    _deviceStateSub = device.state.listen((BluetoothDeviceState state) {
      setState(() {
        _connectionStateText = state.toString().split('.').last;
      });
      _appendLog('Device state: $state');
    });

    await _discoverServicesAndSelectWritable(device);
  }

  Future<void> _discoverServicesAndSelectWritable(BluetoothDevice device) async {
    _appendLog('Discovering services...');
    try {
      final List<BluetoothService> services = await device.discoverServices();
      BluetoothCharacteristic? foundWritable;

      for (final BluetoothService service in services) {
        for (final BluetoothCharacteristic c in service.characteristics) {
          if (c.properties.write || c.properties.writeWithoutResponse) {
            foundWritable = c;
            break;
          }
        }
        if (foundWritable != null) break;
      }

      setState(() {
        _writeCharacteristic = foundWritable;
      });

      if (foundWritable != null) {
        _appendLog(
          'Writable characteristic selected: '
          '${foundWritable.uuid.toString()}',
        );
      } else {
        _appendLog('No writable characteristic found on this device.');
      }
    } on Exception catch (e) {
      _appendLog('Service discovery error: $e');
    }
  }

  Future<void> _disconnectFromDevice() async {
    _deviceStateSub?.cancel();
    _deviceStateSub = null;

    if (_connectedDevice != null) {
      _appendLog('Disconnecting from ${_connectedDevice!.id.id} ...');
      try {
        await _connectedDevice!.disconnect();
      } on Exception catch (e) {
        _appendLog('Disconnect error: $e');
      }
    }

    setState(() {
      _connectedDevice = null;
      _writeCharacteristic = null;
      _connectionStateText = 'Disconnected';
    });
  }

  Future<void> _sendTestPayment() async {
    if (_connectedDevice == null) {
      _appendLog('No device connected.');
      return;
    }
    if (_writeCharacteristic == null) {
      _appendLog('No writable characteristic. Cannot send payment data.');
      return;
    }

    // نمونهٔ پیام پرداخت آفلاین سوما (فقط برای تست)
    final Map<String, dynamic> payload = <String, dynamic>{
      'type': 'soma_demo_payment',
      'amount': 123450, // ریال فرضی
      'currency': 'IRR',
      'timestamp': DateTime.now().toIso8601String(),
    };

    final String jsonString = jsonEncode(payload);
    final List<int> bytes = utf8.encode(jsonString);

    try {
      await _writeCharacteristic!.write(
        bytes,
        withoutResponse: _writeCharacteristic!.properties.writeWithoutResponse,
      );
      _appendLog('Payment payload sent (${bytes.length} bytes).');
    } on Exception catch (e) {
      _appendLog('Write error: $e');
    }
  }

  Widget _buildScanButton() {
    return Row(
      children: <Widget>[
        Expanded(
          child: ElevatedButton(
            onPressed: _isScanning ? null : _startScan,
            child: const Text(
              'اسکن دستگاه‌های بلوتوث',
              style: TextStyle(
                fontSize: 14,
                fontWeight: FontWeight.w600,
              ),
            ),
          ),
        ),
        const SizedBox(width: 8),
        ElevatedButton(
          onPressed: _isScanning ? _stopScan : null,
          style: ElevatedButton.styleFrom(
            backgroundColor: Colors.redAccent,
          ),
          child: const Icon(Icons.stop),
        ),
      ],
    );
  }

  Widget _buildDeviceTile(ScanResult result) {
    final BluetoothDevice device = result.device;
    final bool isConnected =
        _connectedDevice != null && device.id == _connectedDevice!.id;

    final String name =
        device.name.isEmpty ? '(بدون نام) ${device.id.id}' : device.name;

    return Card(
      color: Colors.grey[900],
      child: ListTile(
        title: Text(
          name,
          style: const TextStyle(
            fontSize: 14,
            color: Colors.white,
            fontWeight: FontWeight.w600,
          ),
        ),
        subtitle: Text(
          'RSSI: ${result.rssi}  ·  ID: ${device.id.id}',
          style: TextStyle(
            fontSize: 12,
            color: Colors.grey[300],
          ),
        ),
        trailing: ElevatedButton(
          onPressed: () {
            if (isConnected) {
              _disconnectFromDevice();
            } else {
              _connectToDevice(result);
            }
          },
          style: ElevatedButton.styleFrom(
            backgroundColor: isConnected ? Colors.redAccent : Colors.teal,
          ),
          child: Text(
            isConnected ? 'قطع اتصال' : 'اتصال',
            style: const TextStyle(
              fontSize: 12,
              fontWeight: FontWeight.w600,
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildDeviceList() {
    if (_scanResults.isEmpty) {
      return const Center(
        child: Text(
          'هنوز دستگاهی پیدا نشده.\nروی دکمه اسکن بزن.',
          textAlign: TextAlign.center,
        ),
      );
    }

    return Expanded(
      child: ListView.builder(
        itemCount: _scanResults.length,
        itemBuilder: (BuildContext context, int index) {
          final ScanResult result = _scanResults[index];
          return _buildDeviceTile(result);
        },
      ),
    );
  }

  Widget _buildConnectionInfo() {
    final String deviceText = _connectedDevice == null
        ? 'هیچ دستگاهی متصل نیست'
        : 'متصل به: ${_connectedDevice!.name.isEmpty ? _connectedDevice!.id.id : _connectedDevice!.name}';

    final String writableText = _writeCharacteristic == null
        ? 'کانال نوشتن داده پیدا نشده'
        : 'کانال نوشتن آماده است';

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: <Widget>[
        Text(
          'وضعیت اتصال: $_connectionStateText',
          style: const TextStyle(
            fontSize: 14,
            fontWeight: FontWeight.w600,
          ),
        ),
        const SizedBox(height: 4),
        Text(
          deviceText,
          style: const TextStyle(
            fontSize: 13,
          ),
        ),
        const SizedBox(height: 4),
        Text(
          writableText,
          style: const TextStyle(
            fontSize: 13,
          ),
        ),
        const SizedBox(height: 8),
        Row(
          children: <Widget>[
            Expanded(
              child: ElevatedButton(
                onPressed:
                    (_connectedDevice != null && _writeCharacteristic != null)
                        ? _sendTestPayment
                        : null,
                child: const Text(
                  'ارسال پیام پرداخت تستی سوما',
                  style: TextStyle(
                    fontSize: 13,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
            ),
            const SizedBox(width: 8),
            ElevatedButton(
              onPressed: _connectedDevice != null ? _disconnectFromDevice : null,
              style: ElevatedButton.styleFrom(
                backgroundColor: Colors.redAccent,
              ),
              child: const Icon(Icons.link_off),
            ),
          ],
        ),
      ],
    );
  }

  Widget _buildLogView() {
    return Container(
      height: 160,
      padding: const EdgeInsets.all(8),
      decoration: BoxDecoration(
        color: Colors.grey[900],
        borderRadius: BorderRadius.circular(8),
      ),
      child: SingleChildScrollView(
        reverse: true,
        child: Text(
          _log,
          style: const TextStyle(
            fontSize: 11,
            color: Colors.white70,
          ),
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text(
          'Soma Bluetooth Core (Demo)',
          style: TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.w600,
          ),
        ),
        centerTitle: true,
      ),
      body: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(12),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.stretch,
            children: <Widget>[
              _buildScanButton(),
              const SizedBox(height: 12),
              _buildConnectionInfo(),
              const SizedBox(height: 12),
              _buildDeviceList(),
              const SizedBox(height: 8),
              _buildLogView(),
            ],
          ),
        ),
      ),
    );
  }
}
