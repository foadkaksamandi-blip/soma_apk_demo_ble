name: soma-bt-core

on:
  push:
    branches: [ master ]
    paths:
      - ".github/workflows/soma_bluetooth_core.yml"
  workflow_dispatch:

jobs:
  build-bt-core:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Create or update soma_bluetooth_core project & files
        shell: bash
        run: |
          set -e

          # اگر پروژه وجود نداشت بساز
          if [ ! -d "soma_bluetooth_core" ]; then
            flutter create soma_bluetooth_core
          fi

          # pubspec.yaml مخصوص هسته بلوتوث
          cat > soma_bluetooth_core/pubspec.yaml << 'EOF'
          name: soma_bluetooth_core
          description: Core Bluetooth demo for Soma offline module.
          publish_to: "none"

          version: 1.0.0+1

          environment:
            sdk: ">=3.4.0 <4.0.0"

          dependencies:
            flutter:
              sdk: flutter
            flutter_blue: ^0.8.0

          dev_dependencies:
            flutter_test:
              sdk: flutter
            flutter_lints: ^4.0.0

          flutter:
            uses-material-design: true
          EOF

          # lib/main.dart – هسته ساده بلوتوث واقعی (اسکن + اتصال)
          cat > soma_bluetooth_core/lib/main.dart << 'EOF'
          import 'package:flutter/material.dart';
          import 'package:flutter_blue/flutter_blue.dart';

          void main() {
            WidgetsFlutterBinding.ensureInitialized();
            runApp(const SomaBluetoothCoreApp());
          }

          class SomaBluetoothCoreApp extends StatelessWidget {
            const SomaBluetoothCoreApp({super.key});

            @override
            Widget build(BuildContext context) {
              return MaterialApp(
                debugShowCheckedModeBanner: false,
                title: 'Soma Bluetooth Core',
                theme: ThemeData(
                  colorScheme: ColorScheme.fromSeed(seedColor: Colors.teal),
                  useMaterial3: true,
                ),
                home: const DeviceScanPage(),
              );
            }
          }

          /// صفحه اصلی: اسکن دستگاه‌های اطراف و انتخاب یکی برای اتصال
          class DeviceScanPage extends StatefulWidget {
            const DeviceScanPage({super.key});

            @override
            State<DeviceScanPage> createState() => _DeviceScanPageState();
          }

          class _DeviceScanPageState extends State<DeviceScanPage> {
            final FlutterBlue _flutterBlue = FlutterBlue.instance;
            Stream<List<ScanResult>> get _scanResults => _flutterBlue.scanResults;

            bool _isScanning = false;

            Future<void> _startScan() async {
              if (_isScanning) return;
              setState(() {
                _isScanning = true;
              });
              await _flutterBlue.startScan(
                timeout: const Duration(seconds: 8),
              );
              await Future.delayed(const Duration(seconds: 8));
              await _flutterBlue.stopScan();
              if (mounted) {
                setState(() {
                  _isScanning = false;
                });
              }
            }

            @override
            void initState() {
              super.initState();
              // روی شروع صفحه یک‌بار اسکن
              _startScan();
            }

            @override
            Widget build(BuildContext context) {
              return Scaffold(
                appBar: AppBar(
                  title: const Text('Soma Bluetooth Core'),
                ),
                body: Column(
                  children: [
                    Padding(
                      padding: const EdgeInsets.all(12.0),
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          const Expanded(
                            child: Text(
                              'Nearby Bluetooth LE devices',
                              style: TextStyle(fontSize: 16),
                            ),
                          ),
                          IconButton(
                            icon: Icon(
                              _isScanning ? Icons.stop : Icons.refresh,
                            ),
                            onPressed: _isScanning ? null : _startScan,
                            tooltip: _isScanning ? 'Scanning...' : 'Scan again',
                          ),
                        ],
                      ),
                    ),
                    const Divider(height: 1),
                    Expanded(
                      child: StreamBuilder<List<ScanResult>>(
                        stream: _scanResults,
                        initialData: const [],
                        builder: (context, snapshot) {
                          final results = snapshot.data ?? [];
                          if (results.isEmpty) {
                            return const Center(
                              child: Text('No devices found yet'),
                            );
                          }
                          return ListView.builder(
                            itemCount: results.length,
                            itemBuilder: (context, index) {
                              final r = results[index];
                              final device = r.device;

                              return ListTile(
                                title: Text(
                                  device.name.isNotEmpty
                                      ? device.name
                                      : device.id.id,
                                ),
                                subtitle: Text('RSSI: ${r.rssi}'),
                                trailing: const Icon(Icons.bluetooth),
                                onTap: () {
                                  Navigator.of(context).push(
                                    MaterialPageRoute(
                                      builder: (_) => DeviceDetailPage(
                                        device: device,
                                      ),
                                    ),
                                  );
                                },
                              );
                            },
                          );
                        },
                      ),
                    ),
                  ],
                ),
              );
            }
          }

          /// صفحه جزئیات دستگاه: اتصال / قطع اتصال و نمایش سرویس‌ها
          class DeviceDetailPage extends StatefulWidget {
            const DeviceDetailPage({super.key, required this.device});

            final BluetoothDevice device;

            @override
            State<DeviceDetailPage> createState() => _DeviceDetailPageState();
          }

          class _DeviceDetailPageState extends State<DeviceDetailPage> {
            bool _connecting = false;
            bool _connected = false;
            List<BluetoothService> _services = const [];

            Future<void> _connect() async {
              if (_connected || _connecting) return;
              setState(() {
                _connecting = true;
              });
              try {
                await widget.device.connect();
                final services = await widget.device.discoverServices();
                if (mounted) {
                  setState(() {
                    _services = services;
                    _connected = true;
                  });
                }
              } catch (e) {
                if (mounted) {
                  ScaffoldMessenger.of(context).showSnackBar(
                    SnackBar(
                      content: Text('Connection error: $e'),
                    ),
                  );
                }
              } finally {
                if (mounted) {
                  setState(() {
                    _connecting = false;
                  });
                }
              }
            }

            Future<void> _disconnect() async {
              if (!_connected) return;
              try {
                await widget.device.disconnect();
              } catch (_) {
                // نادیده بگیر
              }
              if (mounted) {
                setState(() {
                  _connected = false;
                  _services = const [];
                });
              }
            }

            @override
            void dispose() {
              _disconnect();
              super.dispose();
            }

            @override
            Widget build(BuildContext context) {
              return Scaffold(
                appBar: AppBar(
                  title: Text(
                    widget.device.name.isNotEmpty
                        ? widget.device.name
                        : widget.device.id.id,
                  ),
                ),
                body: Column(
                  children: [
                    Padding(
                      padding: const EdgeInsets.all(12.0),
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Text(
                            _connected
                                ? 'Connected'
                                : _connecting
                                    ? 'Connecting...'
                                    : 'Disconnected',
                            style: TextStyle(
                              fontSize: 16,
                              fontWeight: FontWeight.w600,
                              color: _connected ? Colors.green : Colors.red,
                            ),
                          ),
                          FilledButton(
                            onPressed: _connecting
                                ? null
                                : _connected
                                    ? _disconnect
                                    : _connect,
                            child: Text(
                              _connected
                                  ? 'Disconnect'
                                  : _connecting
                                      ? 'Please wait'
                                      : 'Connect',
                            ),
                          ),
                        ],
                      ),
                    ),
                    const Divider(height: 1),
                    Expanded(
                      child: _connected
                          ? _buildServiceList()
                          : const Center(
                              child: Text(
                                'Connect to see services & characteristics',
                              ),
                            ),
                    ),
                  ],
                ),
              );
            }

            Widget _buildServiceList() {
              if (_services.isEmpty) {
                return const Center(
                  child: Text('No services discovered yet'),
                );
              }

              return ListView.builder(
                itemCount: _services.length,
                itemBuilder: (context, index) {
                  final service = _services[index];
                  return ExpansionTile(
                    title: Text('Service: ${service.uuid}'),
                    children: service.characteristics.map((c) {
                      return ListTile(
                        title: Text('Characteristic: ${c.uuid}'),
                        subtitle: Text(
                          'properties: '
                          '${c.properties.read ? "read " : ""}'
                          '${c.properties.write ? "write " : ""}'
                          '${c.properties.notify ? "notify " : ""}',
                        ),
                      );
                    }).toList(),
                  );
                },
              );
            }
          }
          EOF

      - name: Get dependencies
        run: |
          cd soma_bluetooth_core
          flutter pub get

      - name: Build soma_bluetooth_core APK (release)
        run: |
          cd soma_bluetooth_core
          flutter build apk --release --no-shrink

      - name: Upload soma_bluetooth_core APK
        uses: actions/upload-artifact@v4
        with:
          name: soma_bluetooth_core-apk
          path: soma_bluetooth_core/build/app/outputs/flutter-apk/app-release.apk
