name: Soma Buyer App

on:
  push:
  pull_request:

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Create app & deps
        run: |
          flutter --version
          rm -rf soma_demo || true
          flutter create --platforms=android soma_demo
          cd soma_demo
          flutter pub add flutter_blue_plus
          flutter pub add mobile_scanner
          flutter pub add qr_flutter

      - name: Write main.dart (Buyer App – Page 1)
        working-directory: soma_demo
        shell: bash
        run: |
          cat > lib/main.dart <<'DART'
          import 'package:flutter/material.dart';

          void main() => runApp(const SomaBuyerApp());

          class SomaBuyerApp extends StatelessWidget {
            const SomaBuyerApp({super.key});

            @override
            Widget build(BuildContext context) {
              return MaterialApp(
                debugShowCheckedModeBanner: false,
                title: 'اپ آفلاین سوما',
                theme: ThemeData(
                  colorSchemeSeed: Colors.teal,
                  useMaterial3: true,
                ),
                home: const Directionality(
                  textDirection: TextDirection.rtl,
                  child: BuyerHomePage(),
                ),
              );
            }
          }

          enum WalletType {
            main,
            subsidy,
            emergency,
            digitalRial,
          }

          class BuyerHomePage extends StatefulWidget {
            const BuyerHomePage({super.key});

            @override
            State<BuyerHomePage> createState() => _BuyerHomePageState();
          }

          class _BuyerHomePageState extends State<BuyerHomePage> {
            WalletType _selectedWallet = WalletType.main;

            final TextEditingController _amountController =
                TextEditingController();
            final TextEditingController _traceController =
                TextEditingController();

            String _status =
                'وضعیت: موجودی اصلی برای پرداخت انتخاب شده است';

            @override
            void dispose() {
              _amountController.dispose();
              _traceController.dispose();
              super.dispose();
            }

            void _selectWallet(WalletType wallet) {
              setState(() {
                _selectedWallet = wallet;
                _status =
                    'وضعیت: ${_walletTitle(wallet)} برای پرداخت انتخاب شد';
              });
            }

            String _walletTitle(WalletType wallet) {
              switch (wallet) {
                case WalletType.main:
                  return 'موجودی اصلی';
                case WalletType.subsidy:
                  return 'موجودی یارانه‌ای';
                case WalletType.emergency:
                  return 'موجودی اضطراری ملی';
                case WalletType.digitalRial:
                  return 'ریال دیجیتال ملی';
              }
            }

            String _walletSubtitle(WalletType wallet) {
              switch (wallet) {
                case WalletType.main:
                  return 'موجودی: ۱۲۰۰۰۰۰ تومان';
                case WalletType.subsidy:
                  return 'موجودی: ۴۰۰۰۰۰ تومان';
                case WalletType.emergency:
                  return 'موجودی: ۲۵۰۰۰۰ تومان';
                case WalletType.digitalRial:
                  return 'موجودی: ۰ ریال';
              }
            }

            void _onPayWithBluetooth() {
              setState(() {
                _status =
                    'وضعیت: آماده‌سازی پرداخت با بلوتوث (دمو بدون اتصال واقعی).';
              });
            }

            void _onPayWithQr() {
              setState(() {
                _status =
                    'وضعیت: آماده‌سازی پرداخت با QR کد (دمو بدون اتصال واقعی).';
              });
            }

            void _onConfirmPayment() {
              final amount = _amountController.text.trim();
              final trace = _traceController.text.trim();
              if (amount.isEmpty) {
                setState(() {
                  _status = 'وضعیت: لطفاً مبلغ پرداخت را وارد کنید.';
                });
                return;
              }
              final walletName = _walletTitle(_selectedWallet);
              setState(() {
                _status =
                    'وضعیت: تراکنش مبلغ $amount از $walletName (کد: ${trace.isEmpty ? 'بدون کد' : trace}) در حالت دمو شبیه‌سازی شد.';
              });
            }

            @override
            Widget build(BuildContext context) {
              return Scaffold(
                appBar: AppBar(
                  title: const Text('اپ آفلاین سوما'),
                  centerTitle: true,
                ),
                body: SingleChildScrollView(
                  padding: const EdgeInsets.all(16),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.stretch,
                    children: [
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: const [
                          SizedBox(width: 8),
                          Text(
                            'اپ خریدار',
                            style: TextStyle(
                              fontSize: 16,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 16),
                      Container(
                        padding: const EdgeInsets.all(20),
                        decoration: BoxDecoration(
                          color: Colors.teal.withOpacity(0.08),
                          borderRadius: BorderRadius.circular(20),
                        ),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.end,
                          children: const [
                            Text(
                              'موجودی اصلی',
                              style: TextStyle(
                                fontSize: 16,
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                            SizedBox(height: 12),
                            Text(
                              '۱۲۰۰۰۰۰ تومان',
                              style: TextStyle(
                                fontSize: 24,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ],
                        ),
                      ),
                      const SizedBox(height: 24),
                      const Align(
                        alignment: Alignment.centerRight,
                        child: Text(
                          'انتخاب نحوه پرداخت',
                          style: TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.w600,
                          ),
                        ),
                      ),
                      const SizedBox(height: 12),
                      FilledButton(
                        onPressed: _onPayWithBluetooth,
                        child: const Text('پرداخت با بلوتوث'),
                      ),
                      const SizedBox(height: 12),
                      FilledButton.tonal(
                        onPressed: _onPayWithQr,
                        child: const Text('پرداخت با QR کد'),
                      ),
                      const SizedBox(height: 24),
                      const Align(
                        alignment: Alignment.centerRight,
                        child: Text(
                          'انتخاب کیف پول برای پرداخت',
                          style: TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.w600,
                          ),
                        ),
                      ),
                      const SizedBox(height: 12),
                      _WalletCard(
                        title: _walletTitle(WalletType.main),
                        subtitle: _walletSubtitle(WalletType.main),
                        selected: _selectedWallet == WalletType.main,
                        onTap: () => _selectWallet(WalletType.main),
                      ),
                      const SizedBox(height: 8),
                      _WalletCard(
                        title: _walletTitle(WalletType.subsidy),
                        subtitle: _walletSubtitle(WalletType.subsidy),
                        selected: _selectedWallet == WalletType.subsidy,
                        onTap: () => _selectWallet(WalletType.subsidy),
                      ),
                      const SizedBox(height: 8),
                      _WalletCard(
                        title: _walletTitle(WalletType.emergency),
                        subtitle: _walletSubtitle(WalletType.emergency),
                        selected: _selectedWallet == WalletType.emergency,
                        onTap: () => _selectWallet(WalletType.emergency),
                      ),
                      const SizedBox(height: 8),
                      _WalletCard(
                        title: _walletTitle(WalletType.digitalRial),
                        subtitle: _walletSubtitle(WalletType.digitalRial),
                        selected: _selectedWallet == WalletType.digitalRial,
                        onTap: () => _selectWallet(WalletType.digitalRial),
                      ),
                      const SizedBox(height: 24),
                      const Align(
                        alignment: Alignment.centerRight,
                        child: Text(
                          'مبلغ پرداخت (تومان)',
                          style: TextStyle(
                            fontSize: 15,
                            fontWeight: FontWeight.w500,
                          ),
                        ),
                      ),
                      const SizedBox(height: 8),
                      TextField(
                        controller: _amountController,
                        keyboardType: TextInputType.number,
                        textAlign: TextAlign.right,
                        decoration: InputDecoration(
                          hintText: 'مثلاً ۲۵۰۰۰ تومان',
                          border: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(16),
                          ),
                        ),
                      ),
                      const SizedBox(height: 16),
                      const Align(
                        alignment: Alignment.centerRight,
                        child: Text(
                          'کد تراکنش',
                          style: TextStyle(
                            fontSize: 15,
                            fontWeight: FontWeight.w500,
                          ),
                        ),
                      ),
                      const SizedBox(height: 8),
                      TextField(
                        controller: _traceController,
                        textAlign: TextAlign.right,
                        decoration: InputDecoration(
                          hintText: 'کد / شناسه تراکنش',
                          border: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(16),
                          ),
                        ),
                      ),
                      const SizedBox(height: 20),
                      FilledButton(
                        onPressed: _onConfirmPayment,
                        child: const Text('تأیید و شروع پرداخت'),
                      ),
                      const SizedBox(height: 16),
                      Text(
                        _status,
                        textAlign: TextAlign.right,
                        style: const TextStyle(
                          fontSize: 13,
                          fontWeight: FontWeight.w500,
                        ),
                      ),
                    ],
                  ),
                ),
              );
            }
          }

          class _WalletCard extends StatelessWidget {
            final String title;
            final String subtitle;
            final bool selected;
            final VoidCallback onTap;

            const _WalletCard({
              required this.title,
              required this.subtitle,
              required this.selected,
              required this.onTap,
            });

            @override
            Widget build(BuildContext context) {
              final colorScheme = Theme.of(context).colorScheme;
              return InkWell(
                borderRadius: BorderRadius.circular(18),
                onTap: onTap,
                child: Container(
                  padding:
                      const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(18),
                    color: selected
                        ? colorScheme.primary.withOpacity(0.08)
                        : Colors.white,
                    border: Border.all(
                      color: selected
                          ? colorScheme.primary
                          : Colors.grey.shade300,
                      width: 1.4,
                    ),
                  ),
                  child: Row(
                    children: [
                      Icon(
                        selected
                            ? Icons.radio_button_checked
                            : Icons.radio_button_off,
                        color: selected
                            ? colorScheme.primary
                            : Colors.grey.shade500,
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.end,
                          children: [
                            Text(
                              title,
                              style: const TextStyle(
                                fontSize: 15,
                                fontWeight: FontWeight.w600,
                              ),
                            ),
                            const SizedBox(height: 4),
                            Text(
                              subtitle,
                              style: TextStyle(
                                fontSize: 13,
                                color: Colors.grey.shade700,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
              );
            }
          }
          DART

      - name: Build release APK
        working-directory: soma_demo
        run: flutter build apk --release --no-shrink

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: soma_buyer_app-release.apk
          path: soma_demo/build/app/outputs/flutter-apk/app-release.apk
