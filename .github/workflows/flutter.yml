name: Soma Demo APK

on:
  push:
  pull_request:

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Create app & deps
        run: |
          flutter --version
          rm -rf soma_demo || true
          flutter create --platforms=android soma_demo
          cd soma_demo
          flutter pub add flutter_blue_plus
          flutter pub add qr_flutter
          flutter pub add mobile_scanner

      - name: Write main.dart
        working-directory: soma_demo
        shell: bash
        run: |
          mkdir -p lib
          cat > lib/main.dart <<'DART'
          import 'dart:convert';
          import 'dart:math';

          import 'package:flutter/material.dart';
          import 'package:flutter_blue_plus/flutter_blue_plus.dart';
          import 'package:qr_flutter/qr_flutter.dart';
          import 'package:mobile_scanner/mobile_scanner.dart';

          void main() {
            runApp(const SomaOfflineBuyerApp());
          }

          class SomaOfflineBuyerApp extends StatelessWidget {
            const SomaOfflineBuyerApp({super.key});

            @override
            Widget build(BuildContext context) {
              return MaterialApp(
                title: 'اپ آفلاین سوما',
                debugShowCheckedModeBanner: false,
                theme: ThemeData(
                  useMaterial3: true,
                  colorSchemeSeed: Colors.teal,
                ),
                home: const BuyerHomePage(),
              );
            }
          }

          class _Wallet {
            final String name;
            final int balance;
            const _Wallet(this.name, this.balance);
          }

          /// صفحه اول – اپ خریدار
          class BuyerHomePage extends StatefulWidget {
            const BuyerHomePage({super.key});

            @override
            State<BuyerHomePage> createState() => _BuyerHomePageState();
          }

          class _BuyerHomePageState extends State<BuyerHomePage> {
            final List<_Wallet> _wallets = const [
              _Wallet('موجودی اصلی', 120000),
              _Wallet('موجودی یارانه‌ای', 400000),
              _Wallet('موجودی اضطراری ملی', 250000),
              _Wallet('ریال دیجیتال ملی', 0),
            ];

            int _selectedWalletIndex = 0;
            final TextEditingController _amountController = TextEditingController();
            final TextEditingController _txCodeController = TextEditingController();
            String _statusText = 'وضعیت: موجودی اصلی برای پرداخت انتخاب شد';

            @override
            void dispose() {
              _amountController.dispose();
              _txCodeController.dispose();
              super.dispose();
            }

            void _updateStatus() {
              final walletName = _wallets[_selectedWalletIndex].name;
              setState(() {
                _statusText = 'وضعیت: $walletName برای پرداخت انتخاب شد';
              });
            }

            int? _parseAmount() {
              final raw = _amountController.text.trim().replaceAll('٬', '').replaceAll(',', '');
              if (raw.isEmpty) return null;
              return int.tryParse(raw);
            }

            void _goToBluetooth() {
              final amount = _parseAmount();
              if (amount == null || amount <= 0) {
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(content: Text('لطفاً مبلغ پرداخت را وارد کنید.')),
                );
                return;
              }

              Navigator.push(
                context,
                MaterialPageRoute(
                  builder: (_) => BluetoothPaymentPage(
                    amount: amount,
                    walletName: _wallets[_selectedWalletIndex].name,
                  ),
                ),
              );
            }

            void _goToQr() {
              final amount = _parseAmount();
              if (amount == null || amount <= 0) {
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(content: Text('لطفاً مبلغ پرداخت را وارد کنید.')),
                );
                return;
              }

              Navigator.push(
                context,
                MaterialPageRoute(
                  builder: (_) => QrPaymentDemoPage(
                    amount: amount,
                    walletName: _wallets[_selectedWalletIndex].name,
                  ),
                ),
              );
            }

            @override
            Widget build(BuildContext context) {
              return Directionality(
                textDirection: TextDirection.rtl,
                child: Scaffold(
                  appBar: AppBar(title: const Text('اپ آفلاین سوما')),
                  body: SingleChildScrollView(
                    padding: const EdgeInsets.all(16),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const Text('اپ خریدار', style: TextStyle(fontSize: 18, fontWeight: FontWeight.w600)),
                        const SizedBox(height: 16),
                        _buildBalanceCard(),
                        const SizedBox(height: 24),
                        const Text('انتخاب نحوه پرداخت', style: TextStyle(fontSize: 16, fontWeight: FontWeight.w600)),
                        const SizedBox(height: 12),

                        FilledButton(
                          onPressed: _goToBluetooth,
                          child: const Text('پرداخت با بلوتوث'),
                        ),
                        const SizedBox(height: 8),

                        FilledButton.tonal(
                          onPressed: _goToQr,
                          child: const Text('پرداخت با QR کد'),
                        ),

                        const SizedBox(height: 24),
                        const Text('انتخاب کیف پول', style: TextStyle(fontSize: 16, fontWeight: FontWeight.w600)),
                        const SizedBox(height: 12),

                        ...List.generate(_wallets.length, (i) {
                          final w = _wallets[i];
                          final selected = i == _selectedWalletIndex;
                          return Padding(
                            padding: const EdgeInsets.only(bottom: 8),
                            child: Container(
                              decoration: BoxDecoration(
                                color: selected ? Colors.teal.withOpacity(0.1) : Colors.white,
                                borderRadius: BorderRadius.circular(16),
                                border: Border.all(color: selected ? Colors.teal : Colors.grey.shade300),
                              ),
                              child: RadioListTile(
                                value: i,
                                groupValue: _selectedWalletIndex,
                                activeColor: Colors.teal,
                                onChanged: (v) {
                                  setState(() {
                                    _selectedWalletIndex = v!;
                                  });
                                  _updateStatus();
                                },
                                title: Text(w.name),
                                subtitle: Text('موجودی: ${w.balance} تومان'),
                              ),
                            ),
                          );
                        }),

                        const SizedBox(height: 20),
                        const Text('مبلغ پرداخت (تومان)'),
                        TextField(
                          controller: _amountController,
                          keyboardType: TextInputType.number,
                          decoration: InputDecoration(
                            hintText: 'مثلاً ۵۰۰۰۰',
                            border: OutlineInputBorder(borderRadius: BorderRadius.circular(16)),
                          ),
                        ),

                        const SizedBox(height: 20),
                        const Text('کد تراکنش'),
                        TextField(
                          controller: _txCodeController,
                          decoration: InputDecoration(
                            hintText: 'کد / شناسه تراکنش',
                            border: OutlineInputBorder(borderRadius: BorderRadius.circular(16)),
                          ),
                        ),

                        const SizedBox(height: 20),
                        FilledButton(
                          onPressed: () {
                            _updateStatus();
                            ScaffoldMessenger.of(context).showSnackBar(
                              const SnackBar(content: Text('اطلاعات ثبت شد. حالا روش پرداخت را انتخاب کنید.')),
                            );
                          },
                          child: const Text('تأیید و شروع پرداخت'),
                        ),
                        const SizedBox(height: 12),
                        Text(_statusText),
                      ],
                    ),
                  ),
                ),
              );
            }

            Widget _buildBalanceCard() {
              final w = _wallets[_selectedWalletIndex];
              return Container(
                width: double.infinity,
                decoration: BoxDecoration(
                  color: Colors.teal.withOpacity(0.06),
                  borderRadius: BorderRadius.circular(20),
                ),
                padding: const EdgeInsets.all(20),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text('موجودی اصلی', style: TextStyle(fontSize: 15)),
                    const SizedBox(height: 8),
                    Text('${w.balance} تومان', style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold)),
                  ],
                ),
              );
            }
          }

          enum ConnectionStatus { idle, scanning, notFound, found, connecting, connected, error }

          /// صفحه دوم – بلوتوث
          class BluetoothPaymentPage extends StatefulWidget {
            final int amount;
            final String walletName;

            const BluetoothPaymentPage({super.key, required this.amount, required this.walletName});

            @override
            State<BluetoothPaymentPage> createState() => _BluetoothPaymentPageState();
          }

          class _BluetoothPaymentPageState extends State<BluetoothPaymentPage> {
            List<ScanResult> _scanResults = [];
            BluetoothDevice? _selectedDevice;
            ConnectionStatus _status = ConnectionStatus.idle;
            bool _isScanning = false;

            String get _statusText {
              switch (_status) {
                case ConnectionStatus.idle: return 'برای شروع، دکمه اسکن را بزنید.';
                case ConnectionStatus.scanning: return 'در حال اسکن دستگاه‌های نزدیک…';
                case ConnectionStatus.notFound: return 'هیچ فروشنده‌ای پیدا نشد.';
                case ConnectionStatus.found: return 'لطفاً یک فروشنده انتخاب کنید.';
                case ConnectionStatus.connecting: return 'در حال برقراری اتصال امن…';
                case ConnectionStatus.connected: return 'اتصال امن برقرار شد.';
                case ConnectionStatus.error: return 'خطا در اتصال.';
              }
            }

            Future<void> _startScan() async {
              setState(() {
                _isScanning = true;
                _scanResults.clear();
                _selectedDevice = null;
                _status = ConnectionStatus.scanning;
              });

              try {
                await FlutterBluePlus.startScan(timeout: const Duration(seconds: 5));
                final results = await FlutterBluePlus.scanResults.first;
                await FlutterBluePlus.stopScan();

                final filtered = results.where((r) {
                  final n = r.device.platformName.toUpperCase();
                  return n.contains('SOMA');
                }).toList();

                setState(() {
                  _scanResults = filtered;
                  _status = filtered.isEmpty ? ConnectionStatus.notFound : ConnectionStatus.found;
                });
              } catch (_) {
                setState(() => _status = ConnectionStatus.error);
              } finally {
                setState(() => _isScanning = false);
              }
            }

            void _selectDevice(ScanResult r) {
              setState(() {
                _selectedDevice = r.device;
                _status = ConnectionStatus.connecting;
              });
              Future.delayed(const Duration(seconds: 1), () {
                setState(() => _status = ConnectionStatus.connected);
              });
            }

            void _confirm() {
              if (_status != ConnectionStatus.connected) return;

              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(content: Text('پرداخت ${widget.amount} تومان با موفقیت انجام شد (دمو).')),
              );
              Navigator.pop(context);
            }

            @override
            Widget build(BuildContext context) {
              return Directionality(
                textDirection: TextDirection.rtl,
                child: Scaffold(
                  appBar: AppBar(title: const Text('اپ آفلاین سوما')),
                  body: SingleChildScrollView(
                    padding: const EdgeInsets.all(16),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const Text('اپ خریدار', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
                        const SizedBox(height: 12),
                        const Text('پرداخت با بلوتوث', style: TextStyle(fontSize: 17, fontWeight: FontWeight.w700)),
                        const SizedBox(height: 16),

                        _summaryCard(),

                        const SizedBox(height: 24),
                        FilledButton(
                          onPressed: _isScanning ? null : _startScan,
                          child: Text(_isScanning ? 'در حال اسکن…' : 'اسکن با بلوتوث'),
                        ),

                        const SizedBox(height: 20),
                        _sellerSection(),

                        const SizedBox(height: 20),
                        const Text('وضعیت اتصال', style: TextStyle(fontSize: 16, fontWeight: FontWeight.w600)),
                        const SizedBox(height: 8),
                        Container(
                          padding: const EdgeInsets.all(12),
                          decoration: BoxDecoration(
                            color: Colors.grey.shade100,
                            borderRadius: BorderRadius.circular(16),
                          ),
                          child: Text(_statusText),
                        ),

                        const SizedBox(height: 20),
                        OutlinedButton(
                          onPressed: _isScanning ? null : _startScan,
                          child: const Text('جست‌وجوی مجدد'),
                        ),

                        const SizedBox(height: 16),
                        FilledButton(
                          onPressed: _status == ConnectionStatus.connected ? _confirm : null,
                          child: const Text('تأیید و ارسال پرداخت'),
                        ),
                      ],
                    ),
                  ),
                ),
              );
            }

            Widget _summaryCard() {
              return Container(
                width: double.infinity,
                decoration: BoxDecoration(
                  color: Colors.teal.withOpacity(0.06),
                  borderRadius: BorderRadius.circular(20),
                ),
                padding: const EdgeInsets.all(20),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text('مبلغ خرید: ${widget.amount} تومان',
                        style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                    const SizedBox(height: 8),
                    Text('کیف پول انتخاب‌شده: ${widget.walletName}'),
                  ],
                ),
              );
            }

            Widget _sellerSection() {
              if (_status == ConnectionStatus.scanning) {
                return Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Colors.grey.shade100,
                    borderRadius: BorderRadius.circular(16),
                  ),
                  child: const Text('در حال جست‌وجوی فروشنده…'),
                );
              }

              if (_scanResults.isEmpty) {
                return Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Colors.grey.shade100,
                    borderRadius: BorderRadius.circular(16),
                  ),
                  child: const Text('هیچ فروشنده‌ای پیدا نشده است.'),
                );
              }

              return Container(
                decoration: BoxDecoration(
                  color: Colors.grey.shade100,
                  borderRadius: BorderRadius.circular(16),
                ),
                child: Column(
                  children: _scanResults.map((r) {
                    return RadioListTile<BluetoothDevice>(
                      value: r.device,
                      groupValue: _selectedDevice,
                      onChanged: (_) => _selectDevice(r),
                      title: Text(r.device.platformName),
                      subtitle: const Text('فروشنده نزدیک'),
                    );
                  }).toList(),
                ),
              );
            }
          }

          /// صفحه سوم – QR واقعی
          class QrPaymentDemoPage extends StatefulWidget {
            final int amount;
            final String walletName;

            const QrPaymentDemoPage({super.key, required this.amount, required this.walletName});

            @override
            State<QrPaymentDemoPage> createState() => _QrPaymentDemoPageState();
          }

          enum QrMode { none, showBuyerQr, scanSellerQr }

          class _QrPaymentDemoPageState extends State<QrPaymentDemoPage> {
            QrMode _mode = QrMode.none;
            String? _buyerQrData;
            String _statusText = 'در انتظار انتخاب حالت QR…';
            bool _canConfirm = false;

            final MobileScannerController _scannerController = MobileScannerController();
            bool _isScanning = false;
            String? _lastScan;

            @override
            void dispose() {
              _scannerController.dispose();
              super.dispose();
            }

            void _generateBuyerQr() {
              final payload = {
                't': 'SOMA_BUYER_QR',
                'amt': widget.amount,
                'w': widget.walletName,
                'tx': 'TX-${DateTime.now().millisecondsSinceEpoch}',
                'nonce': Random().nextInt(999999),
                'ts': DateTime.now().toIso8601String(),
              };

              setState(() {
                _buyerQrData = jsonEncode(payload);
                _mode = QrMode.showBuyerQr;
                _canConfirm = true;
                _statusText = 'QR برای نمایش به فروشنده آماده است.';
              });
            }

            void _scanSellerQr() {
              setState(() {
                _mode = QrMode.scanSellerQr;
                _isScanning = true;
                _canConfirm = false;
                _statusText = 'در حال اسکن QR فروشنده…';
              });
              _scannerController.start();
            }

            void _onDetected(BarcodeCapture cap) {
              if (!_isScanning) return;

              final raw = cap.barcodes.firstOrNull?.rawValue;
              if (raw == null) return;

              _scannerController.stop();
              setState(() => _isScanning = false);

              try {
                final decoded = jsonDecode(raw);

                if (decoded['t'] == 'SOMA_SELLER_QR') {
                  _statusText = 'QR فروشنده معتبر است.';
                  _canConfirm = true;
                } else {
                  _statusText = 'QR معتبر نیست.';
                }
              } catch (e) {
                _statusText = 'فرمت QR معتبر نیست.';
              }
            }

            void _confirm() {
              if (!_canConfirm) return;
              ScaffoldMessenger.of(context).showSnackBar(
                const SnackBar(content: Text('پرداخت با موفقیت انجام شد (دمو).')),
              );
              Navigator.pop(context);
            }

            @override
            Widget build(BuildContext context) {
              return Directionality(
                textDirection: TextDirection.rtl,
                child: Scaffold(
                  appBar: AppBar(title: const Text('اپ آفلاین سوما')),
                  body: SingleChildScrollView(
                    padding: const EdgeInsets.all(16),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const Text('اپ خریدار', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
                        const SizedBox(height: 12),

                        _summary(),

                        const SizedBox(height: 24),
                        const Text('انتخاب حالت QR', style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                        const SizedBox(height: 12),

                        FilledButton(
                          onPressed: _generateBuyerQr,
                          child: const Text('نمایش QR من برای فروشنده'),
                        ),
                        const SizedBox(height: 8),

                        FilledButton.tonal(
                          onPressed: _isScanning ? null : _scanSellerQr,
                          child: const Text('اسکن QR فروشنده'),
                        ),

                        const SizedBox(height: 24),
                        _qrArea(),

                        const SizedBox(height: 24),
                        const Text('وضعیت پرداخت', style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                        const SizedBox(height: 12),

                        Container(
                          padding: const EdgeInsets.all(12),
                          decoration: BoxDecoration(
                            color: Colors.grey.shade100,
                            borderRadius: BorderRadius.circular(16),
                          ),
                          child: Text(_statusText),
                        ),

                        const SizedBox(height: 24),
                        FilledButton(
                          onPressed: _canConfirm ? _confirm : null,
                          child: const Text('تأیید و ارسال پرداخت'),
                        ),
                      ],
                    ),
                  ),
                ),
              );
            }

            Widget _summary() {
              return Container(
                width: double.infinity,
                decoration: BoxDecoration(
                  color: Colors.teal.withOpacity(0.06),
                  borderRadius: BorderRadius.circular(20),
                ),
                padding: const EdgeInsets.all(20),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text('مبلغ خرید: ${widget.amount} تومان',
                        style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                    const SizedBox(height: 8),
                    Text('کیف پول انتخاب‌شده: ${widget.walletName}'),
                  ],
                ),
              );
            }

            Widget _qrArea() {
              if (_mode == QrMode.showBuyerQr && _buyerQrData != null) {
                return Container(
                  width: double.infinity,
                  decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.circular(20),
                    border: Border.all(color: Colors.grey.shade300),
                  ),
                  padding: const EdgeInsets.all(16),
                  child: Column(
                    children: [
                      QrImageView(
                        data: _buyerQrData!,
                        size: 230,
                        version: QrVersions.auto,
                      ),
                      const SizedBox(height: 12),
                      const Text('این کد را فروشنده اسکن کند.'),
                    ],
                  ),
                );
              }

              if (_mode == QrMode.scanSellerQr) {
                return Container(
                  width: double.infinity,
                  height: 260,
                  decoration: BoxDecoration(
                    color: Colors.black,
                    borderRadius: BorderRadius.circular(20),
                  ),
                  child: ClipRRect(
                    borderRadius: BorderRadius.circular(20),
                    child: MobileScanner(
                      controller: _scannerController,
                      onDetect: _onDetected,
                    ),
                  ),
                );
              }

              return Container(
                width: double.infinity,
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: Colors.grey.shade100,
                  borderRadius: BorderRadius.circular(16),
                ),
                child: const Text('لطفاً یک حالت QR انتخاب کنید.'),
              );
            }
          }
          DART

      - name: Build release APK
        working-directory: soma_demo
        run: flutter build apk --release --no-shrink

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: soma_demo_app-release.apk
          path: soma_demo/build/app/outputs/flutter-apk/app-release.apk
