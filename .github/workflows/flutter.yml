name: Soma Buyer Demo APK

on:
  push:
  pull_request:

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Create app & deps
        run: |
          flutter --version
          rm -rf soma_buyer || true
          flutter create --platforms=android soma_buyer
          cd soma_buyer
          flutter pub add flutter_blue_plus
          flutter pub add mobile_scanner
          flutter pub add qr_flutter

      - name: Write main.dart (Buyer)
        working-directory: soma_buyer
        shell: bash
        run: |
          mkdir -p lib
          cat > lib/main.dart <<'DART'
          import 'package:flutter/material.dart';
          import 'package:flutter_blue_plus/flutter_blue_plus.dart';
          import 'package:mobile_scanner/mobile_scanner.dart';
          import 'package:qr_flutter/qr_flutter.dart';

          void main() => runApp(const SomaBuyerApp());

          class SomaBuyerApp extends StatelessWidget {
            const SomaBuyerApp({super.key});

            @override
            Widget build(BuildContext context) {
              return MaterialApp(
                title: 'SOMA Buyer Demo',
                theme: ThemeData(
                  colorSchemeSeed: Colors.teal,
                  useMaterial3: true,
                ),
                home: const BuyerHomePage(),
              );
            }
          }

          class BuyerHomePage extends StatefulWidget {
            const BuyerHomePage({super.key});

            @override
            State<BuyerHomePage> createState() => _BuyerHomePageState();
          }

          class _BuyerHomePageState extends State<BuyerHomePage> {
            String log = 'آماده برای پرداخت';

            @override
            Widget build(BuildContext context) {
              return Scaffold(
                appBar: AppBar(
                  title: const Text('اپ خریدار سوما'),
                ),
                body: Padding(
                  padding: const EdgeInsets.all(16),
                  child: ListView(
                    children: [
                      FilledButton(
                        onPressed: () async {
                          setState(() => log = 'در حال اسکن بلوتوث…');
                          await FlutterBluePlus.startScan(
                            timeout: const Duration(seconds: 5),
                          );
                          final results =
                              await FlutterBluePlus.scanResults.first;
                          setState(
                            () => log =
                                'تعداد دستگاه‌های پیدا شده: ${results.length}',
                          );
                          FlutterBluePlus.stopScan();
                        },
                        child: const Text('پرداخت با بلوتوث'),
                      ),
                      const SizedBox(height: 12),
                      FilledButton.tonal(
                        onPressed: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (_) => const QrShowPage(),
                            ),
                          );
                        },
                        child: const Text('نمایش QR کیف پول من'),
                      ),
                      const SizedBox(height: 12),
                      OutlinedButton(
                        onPressed: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (_) => const QrScanPage(),
                            ),
                          );
                        },
                        child: const Text('پرداخت با اسکن QR'),
                      ),
                      const SizedBox(height: 24),
                      Text('وضعیت: $log'),
                    ],
                  ),
                ),
              );
            }
          }

          class QrShowPage extends StatelessWidget {
            const QrShowPage({super.key});

            @override
            Widget build(BuildContext context) {
              return Scaffold(
                appBar: AppBar(title: const Text('QR خریدار')),
                body: Center(
                  child: QrImageView(
                    data: 'SOMA-BUYER-DEMO-12345',
                    size: 220,
                  ),
                ),
              );
            }
          }

          class QrScanPage extends StatelessWidget {
            const QrScanPage({super.key});

            @override
            Widget build(BuildContext context) {
              return Scaffold(
                appBar: AppBar(title: const Text('اسکن QR فروشنده')),
                body: MobileScanner(
                  onDetect: (capture) {
                    final barcode = capture.barcodes.isNotEmpty
                        ? capture.barcodes.first.rawValue
                        : null;
                    debugPrint('QR فروشنده: $barcode');
                  },
                ),
              );
            }
          }
          DART

      - name: Build release APK
        working-directory: soma_buyer
        run: flutter build apk --release --no-shrink

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: soma_buyer_app-release.apk
          path: soma_buyer/build/app/outputs/flutter-apk/app-release.apk
