import 'package:flutter/material.dart';
import 'package:flutter_blue_plus/flutter_blue_plus.dart';

void main() {
  runApp(const SomaOfflineBuyerApp());
}

class SomaOfflineBuyerApp extends StatelessWidget {
  const SomaOfflineBuyerApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'اپ آفلاین سوما',
      debugShowCheckedModeBanner: false,
      theme: ThemeData(
        useMaterial3: true,
        colorSchemeSeed: Colors.teal,
      ),
      home: const BuyerHomePage(),
    );
  }
}

class _Wallet {
  final String name;
  final int balance;
  const _Wallet(this.name, this.balance);
}

/// صفحه اول – اپ خریدار
class BuyerHomePage extends StatefulWidget {
  const BuyerHomePage({super.key});

  @override
  State<BuyerHomePage> createState() => _BuyerHomePageState();
}

class _BuyerHomePageState extends State<BuyerHomePage> {
  final List<_Wallet> _wallets = const [
    _Wallet('موجودی اصلی', 120000),
    _Wallet('موجودی یارانه‌ای', 400000),
    _Wallet('موجودی اضطراری ملی', 250000),
    _Wallet('ریال دیجیتال ملی', 0),
  ];

  int _selectedWalletIndex = 0;
  final TextEditingController _amountController = TextEditingController();
  final TextEditingController _txCodeController = TextEditingController();
  String _statusText = 'وضعیت: موجودی اصلی برای پرداخت انتخاب شد';

  @override
  void dispose() {
    _amountController.dispose();
    _txCodeController.dispose();
    super.dispose();
  }

  void _updateStatus() {
    final walletName = _wallets[_selectedWalletIndex].name;
    setState(() {
      _statusText = 'وضعیت: $walletName برای پرداخت انتخاب شد';
    });
  }

  int? _parseAmount() {
    final raw = _amountController.text.trim().replaceAll('٬', '').replaceAll(',', '');
    if (raw.isEmpty) return null;
    final value = int.tryParse(raw);
    return value;
  }

  void _goToBluetooth() {
    final amount = _parseAmount();
    if (amount == null || amount <= 0) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('لطفاً مبلغ پرداخت را به‌صورت عددی وارد کنید.')),
      );
      return;
    }

    final walletName = _wallets[_selectedWalletIndex].name;
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (_) => BluetoothPaymentPage(
          amount: amount,
          walletName: walletName,
        ),
      ),
    );
  }

  void _goToQrDemo() {
    final amount = _parseAmount();
    if (amount == null || amount <= 0) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('لطفاً مبلغ پرداخت را به‌صورت عددی وارد کنید.')),
      );
      return;
    }
    final walletName = _wallets[_selectedWalletIndex].name;
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (_) => QrPaymentDemoPage(
          amount: amount,
          walletName: walletName,
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Directionality(
      textDirection: TextDirection.rtl,
      child: Scaffold(
        appBar: AppBar(
          title: const Text('اپ آفلاین سوما'),
        ),
        body: SingleChildScrollView(
          padding: const EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Align(
                alignment: Alignment.centerRight,
                child: Text(
                  'اپ خریدار',
                  style: TextStyle(fontSize: 18, fontWeight: FontWeight.w600),
                ),
              ),
              const SizedBox(height: 16),
              _buildBalanceCard(),
              const SizedBox(height: 24),
              const Text(
                'انتخاب نحوه پرداخت',
                style: TextStyle(fontSize: 16, fontWeight: FontWeight.w600),
              ),
              const SizedBox(height: 12),
              SizedBox(
                width: double.infinity,
                child: FilledButton(
                  onPressed: _goToBluetooth,
                  child: const Text('پرداخت با بلوتوث'),
                ),
              ),
              const SizedBox(height: 8),
              SizedBox(
                width: double.infinity,
                child: FilledButton.tonal(
                  onPressed: _goToQrDemo,
                  child: const Text('پرداخت با QR کد'),
                ),
              ),
              const SizedBox(height: 24),
              const Text(
                'انتخاب کیف پول برای پرداخت',
                style: TextStyle(fontSize: 16, fontWeight: FontWeight.w600),
              ),
              const SizedBox(height: 12),
              ...List.generate(_wallets.length, (index) {
                final w = _wallets[index];
                final selected = index == _selectedWalletIndex;
                return Padding(
                  padding: const EdgeInsets.only(bottom: 8),
                  child: InkWell(
                    onTap: () {
                      setState(() {
                        _selectedWalletIndex = index;
                      });
                      _updateStatus();
                    },
                    borderRadius: BorderRadius.circular(16),
                    child: Container(
                      decoration: BoxDecoration(
                        color: selected ? Colors.teal.withOpacity(0.1) : Colors.white,
                        borderRadius: BorderRadius.circular(16),
                        border: Border.all(
                          color: selected ? Colors.teal : Colors.grey.shade300,
                          width: 1.4,
                        ),
                      ),
                      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
                      child: Row(
                        children: [
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  w.name,
                                  style: const TextStyle(
                                    fontSize: 15,
                                    fontWeight: FontWeight.w600,
                                  ),
                                ),
                                const SizedBox(height: 4),
                                Text(
                                  'موجودی: ${w.balance} تومان',
                                  style: TextStyle(
                                    fontSize: 13,
                                    color: Colors.grey.shade700,
                                  ),
                                ),
                              ],
                            ),
                          ),
                          Radio<int>(
                            value: index,
                            groupValue: _selectedWalletIndex,
                            onChanged: (v) {
                              if (v == null) return;
                              setState(() {
                                _selectedWalletIndex = v;
                              });
                              _updateStatus();
                            },
                          ),
                        ],
                      ),
                    ),
                  ),
                );
              }),
              const SizedBox(height: 16),
              const Text(
                'مبلغ پرداخت (تومان)',
                style: TextStyle(fontSize: 15, fontWeight: FontWeight.w500),
              ),
              const SizedBox(height: 8),
              TextField(
                controller: _amountController,
                keyboardType: TextInputType.number,
                decoration: InputDecoration(
                  hintText: 'مثلاً ۲۵۰۰۰ تومان',
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(16),
                  ),
                ),
              ),
              const SizedBox(height: 16),
              const Text(
                'کد تراکنش',
                style: TextStyle(fontSize: 15, fontWeight: FontWeight.w500),
              ),
              const SizedBox(height: 8),
              TextField(
                controller: _txCodeController,
                decoration: InputDecoration(
                  hintText: 'کد / شناسه تراکنش',
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(16),
                  ),
                ),
              ),
              const SizedBox(height: 16),
              SizedBox(
                width: double.infinity,
                child: FilledButton(
                  onPressed: () {
                    _updateStatus();
                    ScaffoldMessenger.of(context).showSnackBar(
                      const SnackBar(content: Text('اطلاعات پرداخت ثبت شد. اکنون روش پرداخت را انتخاب کنید.')),
                    );
                  },
                  child: const Text('تأیید و شروع پرداخت'),
                ),
              ),
              const SizedBox(height: 12),
              Text(
                _statusText,
                style: TextStyle(
                  fontSize: 13,
                  color: Colors.grey.shade800,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildBalanceCard() {
    final w = _wallets[_selectedWalletIndex];
    return Container(
      width: double.infinity,
      decoration: BoxDecoration(
        color: Colors.teal.withOpacity(0.06),
        borderRadius: BorderRadius.circular(20),
      ),
      padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 24),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text(
            'موجودی اصلی',
            style: TextStyle(fontSize: 15),
          ),
          const SizedBox(height: 8),
          Text(
            '${w.balance} تومان',
            style: const TextStyle(
              fontSize: 24,
              fontWeight: FontWeight.bold,
            ),
          ),
        ],
      ),
    );
  }
}

enum ConnectionStatus {
  idle,
  scanning,
  notFound,
  found,
  connecting,
  connected,
  error,
}

/// صفحه دوم – پرداخت با بلوتوث
class BluetoothPaymentPage extends StatefulWidget {
  final int amount;
  final String walletName;

  const BluetoothPaymentPage({
    super.key,
    required this.amount,
    required this.walletName,
  });

  @override
  State<BluetoothPaymentPage> createState() => _BluetoothPaymentPageState();
}

class _BluetoothPaymentPageState extends State<BluetoothPaymentPage> {
  List<ScanResult> _scanResults = [];
  BluetoothDevice? _selectedDevice;
  ConnectionStatus _status = ConnectionStatus.idle;
  bool _isScanning = false;

  String get _statusText {
    switch (_status) {
      case ConnectionStatus.idle:
        return 'برای شروع جست‌وجو، دکمه اسکن با بلوتوث را بزنید.';
      case ConnectionStatus.scanning:
        return 'در حال جست‌وجو برای اپ‌های فروشنده نزدیک…';
      case ConnectionStatus.notFound:
        return 'هیچ اپ فروشنده مجاز (با شناسه SOMA-) پیدا نشد.';
      case ConnectionStatus.found:
        return 'فروشنده‌های مجاز پیدا شد. لطفاً یکی را انتخاب کنید.';
      case ConnectionStatus.connecting:
        return 'اپ فروشنده انتخاب شد. در حال برقراری اتصال امن…';
      case ConnectionStatus.connected:
        return 'اتصال امن برقرار شد. می‌توانید پرداخت را ارسال کنید.';
      case ConnectionStatus.error:
        return 'خطا در اتصال. لطفاً دوباره تلاش کنید.';
    }
  }

  bool get _canConfirm {
    return _selectedDevice != null && _status == ConnectionStatus.connected;
  }

  Future<void> _startScan() async {
    setState(() {
      _isScanning = true;
      _status = ConnectionStatus.scanning;
      _scanResults = [];
      _selectedDevice = null;
    });

    try {
      await FlutterBluePlus.startScan(timeout: const Duration(seconds: 5));
      final results = await FlutterBluePlus.scanResults.first;
      await FlutterBluePlus.stopScan();

      final filtered = results.where((r) {
        final name = r.device.platformName.toUpperCase();
        return name.contains('SOMA') || name.contains('STORE');
      }).toList();

      setState(() {
        _scanResults = filtered;
        if (_scanResults.isEmpty) {
          _status = ConnectionStatus.notFound;
        } else {
          _status = ConnectionStatus.found;
        }
      });
    } catch (e) {
      setState(() {
        _status = ConnectionStatus.error;
      });
    } finally {
      setState(() {
        _isScanning = false;
      });
    }
  }

  void _selectDevice(ScanResult r) {
    setState(() {
      _selectedDevice = r.device;
      _status = ConnectionStatus.connecting;
    });

    // شبیه‌سازی برقراری اتصال امن در دمو
    Future.delayed(const Duration(seconds: 1), () {
      if (!mounted) return;
      setState(() {
        _status = ConnectionStatus.connected;
      });
    });
  }

  void _confirmAndSend() {
    if (!_canConfirm) return;

    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(
          'پرداخت ${widget.amount} تومان به فروشنده "${_selectedDevice?.platformName}" در حالت دمو ارسال شد.',
        ),
      ),
    );

    Navigator.pop(context);
  }

  @override
  Widget build(BuildContext context) {
    final amountText = '${widget.amount} تومان';

    return Directionality(
      textDirection: TextDirection.rtl,
      child: Scaffold(
        appBar: AppBar(
          title: const Text('اپ آفلاین سوما'),
        ),
        body: SingleChildScrollView(
          padding: const EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Align(
                alignment: Alignment.centerRight,
                child: Text(
                  'اپ خریدار',
                  style: TextStyle(fontSize: 18, fontWeight: FontWeight.w600),
                ),
              ),
              const SizedBox(height: 16),
              const Align(
                alignment: Alignment.centerRight,
                child: Text(
                  'پرداخت با بلوتوث',
                  style: TextStyle(fontSize: 17, fontWeight: FontWeight.w700),
                ),
              ),
              const SizedBox(height: 16),
              // کارت خلاصه پرداخت
              Container(
                width: double.infinity,
                decoration: BoxDecoration(
                  color: Colors.teal.withOpacity(0.06),
                  borderRadius: BorderRadius.circular(20),
                ),
                padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 20),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      'مبلغ خرید: $amountText',
                      style: const TextStyle(fontSize: 16, fontWeight: FontWeight.w600),
                    ),
                    const SizedBox(height: 8),
                    Text(
                      'کیف پول انتخاب‌شده: ${widget.walletName}',
                      style: const TextStyle(fontSize: 14),
                    ),
                  ],
                ),
              ),
              const SizedBox(height: 24),
              SizedBox(
                width: double.infinity,
                child: FilledButton(
                  onPressed: _isScanning ? null : _startScan,
                  child: Text(
                    _isScanning ? 'در حال اسکن بلوتوث…' : 'اسکن با بلوتوث برای پیدا کردن فروشنده',
                  ),
                ),
              ),
              const SizedBox(height: 20),
              const Text(
                'اپ فروشنده',
                style: TextStyle(fontSize: 16, fontWeight: FontWeight.w600),
              ),
              const SizedBox(height: 8),
              _buildSellerBox(),
              const SizedBox(height: 20),
              const Text(
                'وضعیت اتصال',
                style: TextStyle(fontSize: 16, fontWeight: FontWeight.w600),
              ),
              const SizedBox(height: 8),
              Container(
                width: double.infinity,
                decoration: BoxDecoration(
                  color: Colors.grey.shade100,
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(color: Colors.grey.shade300),
                ),
                padding: const EdgeInsets.all(12),
                child: Text(
                  _statusText,
                  style: const TextStyle(fontSize: 14),
                ),
              ),
              const SizedBox(height: 16),
              SizedBox(
                width: double.infinity,
                child: OutlinedButton(
                  onPressed: _isScanning ? null : _startScan,
                  child: const Text('جست‌وجوی مجدد با بلوتوث'),
                ),
              ),
              const SizedBox(height: 16),
              SizedBox(
                width: double.infinity,
                child: FilledButton(
                  onPressed: _canConfirm ? _confirmAndSend : null,
                  child: const Text('تأیید و ارسال پرداخت'),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildSellerBox() {
    if (_status == ConnectionStatus.scanning) {
      return Container(
        width: double.infinity,
        decoration: BoxDecoration(
          color: Colors.grey.shade100,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: Colors.grey.shade300),
        ),
        padding: const EdgeInsets.all(12),
        child: Row(
          children: const [
            SizedBox(
              width: 22,
              height: 22,
              child: CircularProgressIndicator(strokeWidth: 2),
            ),
            SizedBox(width: 12),
            Expanded(
              child: Text('در حال جست‌وجو برای اپ‌های فروشنده نزدیک…'),
            ),
          ],
        ),
      );
    }

    if (_scanResults.isEmpty) {
      return Container(
        width: double.infinity,
        decoration: BoxDecoration(
          color: Colors.grey.shade100,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: Colors.grey.shade300),
        ),
        padding: const EdgeInsets.all(12),
        child: const Text(
          'هنوز فروشنده‌ای پیدا نشده است. لطفاً اسکن را شروع کنید.',
          style: TextStyle(fontSize: 14),
        ),
      );
    }

    return Container(
      width: double.infinity,
      decoration: BoxDecoration(
        color: Colors.grey.shade100,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: Colors.grey.shade300),
      ),
      padding: const EdgeInsets.all(8),
      child: Column(
        children: _scanResults.map((r) {
          final device = r.device;
          final name = device.platformName.isNotEmpty
              ? device.platformName
              : 'Unknown (${device.remoteId.str})';
          final selected = _selectedDevice?.remoteId == device.remoteId;
          return RadioListTile<BluetoothDevice>(
            value: device,
            groupValue: _selectedDevice,
            onChanged: (d) {
              if (d != null) {
                _selectDevice(r);
              }
            },
            activeColor: Colors.teal,
            title: Text(name),
            subtitle: const Text('فروشنده مجاز نزدیک (دمو)'),
            selected: selected,
          );
        }).toList(),
      ),
    );
  }
}

/// صفحه دمو برای پرداخت با QR (فعلاً ساده)
class QrPaymentDemoPage extends StatelessWidget {
  final int amount;
  final String walletName;

  const QrPaymentDemoPage({
    super.key,
    required this.amount,
    required this.walletName,
  });

  @override
  Widget build(BuildContext context) {
    final amountText = '$amount تومان';

    return Directionality(
      textDirection: TextDirection.rtl,
      child: Scaffold(
        appBar: AppBar(
          title: const Text('اپ آفلاین سوما'),
        ),
        body: Padding(
          padding: const EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text(
                'اپ خریدار',
                style: TextStyle(fontSize: 18, fontWeight: FontWeight.w600),
              ),
              const SizedBox(height: 16),
              const Text(
                'پرداخت با QR کد (دمو)',
                style: TextStyle(fontSize: 17, fontWeight: FontWeight.w700),
              ),
              const SizedBox(height: 16),
              Container(
                width: double.infinity,
                decoration: BoxDecoration(
                  color: Colors.teal.withOpacity(0.06),
                  borderRadius: BorderRadius.circular(20),
                ),
                padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 20),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      'مبلغ خرید: $amountText',
                      style: const TextStyle(fontSize: 16, fontWeight: FontWeight.w600),
                    ),
                    const SizedBox(height: 8),
                    Text(
                      'کیف پول انتخاب‌شده: $walletName',
                      style: const TextStyle(fontSize: 14),
                    ),
                  ],
                ),
              ),
              const SizedBox(height: 24),
              const Text(
                'در نسخه نهایی، در این صفحه QR پرداخت خریدار نمایش و اسکن می‌شود.\n'
                'فعلاً این صفحه فقط برای تست ساخت APK است.',
                style: TextStyle(fontSize: 14),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
