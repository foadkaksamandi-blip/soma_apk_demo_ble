name: Flutter CI

on:
  push:
    branches: [ "master" ]

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: Set up job
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Flutter 3.10.5
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.10.5"

      - name: Flutter doctor
        run: flutter doctor -v

      # --- ایجاد کامل پروژه فلاتر ---
      - name: Create Flutter project
        run: |
          flutter create soma_demo
          rm -rf soma_demo/lib/main.dart

      # --- قرار دادن کل main.dart ---
      - name: Write main.dart
        working-directory: soma_demo/lib
        run: |
          cat > main.dart <<'DART'
import 'package:flutter/material.dart';
import 'package:flutter_blue/flutter_blue.dart';
import 'package:qr_flutter/qr_flutter.dart';
import 'package:qr_code_scanner/qr_code_scanner.dart';

void main() {
  runApp(const SomaApp());
}

class SomaApp extends StatelessWidget {
  const SomaApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      home: const SomaHome(),
    );
  }
}

class SomaHome extends StatefulWidget {
  const SomaHome({super.key});

  @override
  State<SomaHome> createState() => _SomaHomeState();
}

class _SomaHomeState extends State<SomaHome> {
  final FlutterBlue flutterBlue = FlutterBlue.instance;
  String log = "Idle";

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text("SOMA Demo")),
      body: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          children: [
            ElevatedButton(
              onPressed: () async {
                setState(() => log = "Scanning BLE...");
                flutterBlue.startScan(timeout: const Duration(seconds: 3));
              },
              child: const Text("Scan Bluetooth"),
            ),
            const SizedBox(height: 12),
            ElevatedButton(
              onPressed: () {},
              child: const Text("Show My QR"),
            ),
            const SizedBox(height: 12),
            ElevatedButton(
              onPressed: () {},
              child: const Text("Scan QR"),
            ),
            const SizedBox(height: 24),
            Text("Log: $log"),
          ],
        ),
      ),
    );
  }
}
DART

      # --- افزودن دسترسی‌های اندروید ---
      - name: Patch Android permissions
        working-directory: soma_demo
        run: |
          MANIFEST=android/app/src/main/AndroidManifest.xml
          sed -i 's#</manifest>#  <uses-permission android:name="android.permission.BLUETOOTH"/>\n  <uses-permission android:name="android.permission.BLUETOOTH_ADMIN"/>\n  <uses-permission android:name="android.permission.BLUETOOTH_CONNECT" />\n  <uses-permission android:name="android.permission.BLUETOOTH_SCAN" />\n  <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/>\n  <uses-permission android:name="android.permission.CAMERA"/>\n</manifest>#' $MANIFEST

      # --- نصب پکیج‌ها ---
      - name: Pub get
        working-directory: soma_demo
        run: flutter pub add flutter_blue qr_flutter qr_code_scanner

      # --- بیلد APK ---
      - name: Build APK
        working-directory: soma_demo
        run: flutter build apk --release --no-shrink

      # --- خروجی گرفتن APK ---
      - name: Upload APK
        uses: actions/upload-artifact@v3
        with:
          name: SOMA_DEMO_APK
          path: soma_demo/build/app/outputs/flutter-apk/app-release.apk
