name: Soma Demo APK

on:
  push:
  pull_request:

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Create app & deps
        run: |
          flutter --version
          rm -rf soma_demo || true
          flutter create --platforms=android soma_demo
          cd soma_demo
          flutter pub add flutter_blue_plus
          flutter pub add mobile_scanner
          flutter pub add qr_flutter

      - name: Write main.dart (buyer app with BT page)
        working-directory: soma_demo
        shell: bash
        run: |
          mkdir -p lib
          cat > lib/main.dart <<'DART'
          import 'dart:async';

          import 'package:flutter/material.dart';
          import 'package:flutter_blue_plus/flutter_blue_plus.dart';

          void main() {
            runApp(const SomaOfflineBuyerApp());
          }

          class SomaOfflineBuyerApp extends StatelessWidget {
            const SomaOfflineBuyerApp({super.key});

            @override
            Widget build(BuildContext context) {
              return MaterialApp(
                debugShowCheckedModeBanner: false,
                title: 'اپ آفلاین سوما',
                theme: ThemeData(
                  useMaterial3: true,
                  colorSchemeSeed: Colors.teal,
                  fontFamily: 'sans',
                ),
                home: const BuyerHomePage(),
              );
            }
          }

          enum WalletType { main, subsidy, emergency, digitalRial }

          class PaymentData {
            final int amount;
            final WalletType wallet;
            final String walletTitle;
            final String txCode;

            const PaymentData({
              required this.amount,
              required this.wallet,
              required this.walletTitle,
              required this.txCode,
            });
          }

          /// صفحه اول – اپ خریدار
          class BuyerHomePage extends StatefulWidget {
            const BuyerHomePage({super.key});

            @override
            State<BuyerHomePage> createState() => _BuyerHomePageState();
          }

          class _BuyerHomePageState extends State<BuyerHomePage> {
            final int _mainBalance = 1200000;
            final int _subsidyBalance = 400000;
            final int _emergencyBalance = 250000;
            final int _digitalRialBalance = 0;

            WalletType _selectedWallet = WalletType.main;

            final TextEditingController _amountController =
                TextEditingController();
            final TextEditingController _txController = TextEditingController();

            String _status = 'موجودی اصلی برای پرداخت انتخاب شده است.';

            @override
            void dispose() {
              _amountController.dispose();
              _txController.dispose();
              super.dispose();
            }

            String _walletTitle(WalletType t) {
              switch (t) {
                case WalletType.main:
                  return 'موجودی اصلی';
                case WalletType.subsidy:
                  return 'موجودی یارانه‌ای';
                case WalletType.emergency:
                  return 'موجودی اضطراری ملی';
                case WalletType.digitalRial:
                  return 'ریال دیجیتال ملی';
              }
            }

            int _walletBalance(WalletType t) {
              switch (t) {
                case WalletType.main:
                  return _mainBalance;
                case WalletType.subsidy:
                  return _subsidyBalance;
                case WalletType.emergency:
                  return _emergencyBalance;
                case WalletType.digitalRial:
                  return _digitalRialBalance;
              }
            }

            void _onSelectWallet(WalletType t) {
              setState(() {
                _selectedWallet = t;
                _status = '${_walletTitle(t)} برای پرداخت انتخاب شد.';
              });
            }

            void _startBluetoothPayment() {
              final text =
                  _amountController.text.replaceAll(',', '').trim();
              if (text.isEmpty) {
                setState(() {
                  _status = 'لطفاً مبلغ پرداخت را وارد کنید.';
                });
                return;
              }

              final amount = int.tryParse(text) ?? 0;
              if (amount <= 0) {
                setState(() {
                  _status = 'مبلغ واردشده نامعتبر است.';
                });
                return;
              }

              final balance = _walletBalance(_selectedWallet);
              if (amount > balance) {
                setState(() {
                  _status = 'مبلغ بیشتر از موجودی کیف پول انتخاب‌شده است.';
                });
                return;
              }

              final data = PaymentData(
                amount: amount,
                wallet: _selectedWallet,
                walletTitle: _walletTitle(_selectedWallet),
                txCode: _txController.text.trim(),
              );

              Navigator.push(
                context,
                MaterialPageRoute(
                  builder: (_) => BluetoothPaymentPage(data: data),
                ),
              );
            }

            @override
            Widget build(BuildContext context) {
              return Directionality(
                textDirection: TextDirection.rtl,
                child: Scaffold(
                  appBar: AppBar(
                    title: const Text('اپ آفلاین سوما'),
                    centerTitle: true,
                  ),
                  body: Padding(
                    padding: const EdgeInsets.all(16),
                    child: ListView(
                      children: [
                        const Align(
                          alignment: Alignment.centerRight,
                          child: Text(
                            'اپ خریدار',
                            style: TextStyle(
                              fontSize: 18,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ),
                        const SizedBox(height: 16),

                        // کارت موجودی اصلی
                        Container(
                          padding: const EdgeInsets.all(20),
                          decoration: BoxDecoration(
                            color: Colors.teal.shade50,
                            borderRadius: BorderRadius.circular(16),
                          ),
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              const Text(
                                'موجودی اصلی',
                                style: TextStyle(fontSize: 18),
                              ),
                              const SizedBox(height: 6),
                              Text(
                                '$_mainBalance تومان',
                                style: const TextStyle(
                                  fontSize: 24,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                            ],
                          ),
                        ),
                        const SizedBox(height: 24),

                        const Text(
                          'انتخاب نحوه پرداخت',
                          style: TextStyle(
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        const SizedBox(height: 12),

                        FilledButton(
                          onPressed: _startBluetoothPayment,
                          child: const Row(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              Icon(Icons.bluetooth),
                              SizedBox(width: 8),
                              Text('پرداخت با بلوتوث'),
                            ],
                          ),
                        ),
                        const SizedBox(height: 12),
                        FilledButton.tonal(
                          onPressed: () {
                            // بعداً صفحه QR را اضافه می‌کنیم
                          },
                          child: const Text('پرداخت با QR کد'),
                        ),

                        const SizedBox(height: 24),

                        const Text(
                          'انتخاب کیف پول برای پرداخت',
                          style: TextStyle(
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        const SizedBox(height: 12),

                        _WalletCard(
                          title: 'موجودی اصلی',
                          subtitle: 'موجودی: $_mainBalance تومان',
                          selected: _selectedWallet == WalletType.main,
                          onTap: () => _onSelectWallet(WalletType.main),
                        ),
                        _WalletCard(
                          title: 'موجودی یارانه‌ای',
                          subtitle: 'موجودی: $_subsidyBalance تومان',
                          selected: _selectedWallet == WalletType.subsidy,
                          onTap: () => _onSelectWallet(WalletType.subsidy),
                        ),
                        _WalletCard(
                          title: 'موجودی اضطراری ملی',
                          subtitle: 'موجودی: $_emergencyBalance تومان',
                          selected: _selectedWallet == WalletType.emergency,
                          onTap: () => _onSelectWallet(WalletType.emergency),
                        ),
                        _WalletCard(
                          title: 'ریال دیجیتال ملی',
                          subtitle: 'موجودی: $_digitalRialBalance تومان',
                          selected: _selectedWallet == WalletType.digitalRial,
                          onTap: () => _onSelectWallet(WalletType.digitalRial),
                        ),

                        const SizedBox(height: 24),

                        const Text(
                          'مبلغ پرداخت (تومان)',
                          style: TextStyle(fontSize: 16),
                        ),
                        const SizedBox(height: 8),
                        TextField(
                          controller: _amountController,
                          keyboardType: TextInputType.number,
                          decoration: const InputDecoration(
                            border: OutlineInputBorder(),
                            hintText: 'مثلاً ۲۵۰۰۰۰',
                          ),
                        ),
                        const SizedBox(height: 16),

                        const Text(
                          'کد تراکنش',
                          style: TextStyle(fontSize: 16),
                        ),
                        const SizedBox(height: 8),
                        TextField(
                          controller: _txController,
                          decoration: const InputDecoration(
                            border: OutlineInputBorder(),
                            hintText: 'کد / شناسه تراکنش',
                          ),
                        ),
                        const SizedBox(height: 24),

                        FilledButton(
                          onPressed: _startBluetoothPayment,
                          child: const Text('تأیید و شروع پرداخت'),
                        ),
                        const SizedBox(height: 12),

                        Text('وضعیت: $_status'),
                      ],
                    ),
                  ),
                ),
              );
            }
          }

          class _WalletCard extends StatelessWidget {
            final String title;
            final String subtitle;
            final bool selected;
            final VoidCallback onTap;

            const _WalletCard({
              required this.title,
              required this.subtitle,
              required this.selected,
              required this.onTap,
            });

            @override
            Widget build(BuildContext context) {
              return Padding(
                padding: const EdgeInsets.symmetric(vertical: 6),
                child: InkWell,
0
