name: Soma Demo APK

on:
  push:
  pull_request:

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Create app & deps
        run: |
          flutter --version
          rm -rf soma_demo || true
          flutter create --platforms=android soma_demo
          cd soma_demo
          flutter pub add flutter_blue_plus
          flutter pub add mobile_scanner
          flutter pub add qr_flutter

      - name: Write main.dart
        working-directory: soma_demo
        shell: bash
        run: |
          mkdir -p lib
          cat > lib/main.dart <<'DART'
          import 'package:flutter/material.dart';

          void main() {
            runApp(const SomaOfflineApp());
          }

          class SomaOfflineApp extends StatelessWidget {
            const SomaOfflineApp({super.key});

            @override
            Widget build(BuildContext context) {
              return MaterialApp(
                title: 'SOMA Offline Demo',
                theme: ThemeData(
                  colorSchemeSeed: Colors.teal,
                  useMaterial3: true,
                  fontFamily: 'Roboto',
                ),
                home: const Directionality(
                  textDirection: TextDirection.rtl,
                  child: BuyerHomePage(),
                ),
              );
            }
          }

          enum PaymentMethod { bluetooth, qr }

          class WalletInfo {
            final String id;
            final String title;
            final int balance;
            final String description;

            const WalletInfo({
              required this.id,
              required this.title,
              required this.balance,
              required this.description,
            });
          }

          class PaymentRequest {
            final WalletInfo wallet;
            final int amount;
            final String? manualCode;

            const PaymentRequest({
              required this.wallet,
              required this.amount,
              required this.manualCode,
            });
          }

          class BuyerHomePage extends StatefulWidget {
            const BuyerHomePage({super.key});

            @override
            State<BuyerHomePage> createState() => _BuyerHomePageState();
          }

          class _BuyerHomePageState extends State<BuyerHomePage> {
            PaymentMethod _method = PaymentMethod.bluetooth;
            late WalletInfo _selectedWallet;
            final List<WalletInfo> _wallets = const [
              WalletInfo(
                id: 'main',
                title: 'موجودی اصلی',
                balance: 120000,
                description: 'موجودی: ۱۲۰٬۰۰۰ تومان',
              ),
              WalletInfo(
                id: 'subsidy',
                title: 'موجودی یارانه‌ای',
                balance: 400000,
                description: 'موجودی: ۴۰۰٬۰۰۰ تومان',
              ),
              WalletInfo(
                id: 'emergency',
                title: 'موجودی اضطراری ملی',
                balance: 250000,
                description: 'موجودی: ۲۵۰٬۰۰۰ تومان',
              ),
              WalletInfo(
                id: 'digital_rial',
                title: 'ریال دیجیتال ملی',
                balance: 0,
                description: 'موجودی: ۰ ریال',
              ),
            ];

            final TextEditingController _amountController =
                TextEditingController();
            final TextEditingController _codeController = TextEditingController();
            String? _statusText;
            String? _lastTransactionCode;

            @override
            void initState() {
              super.initState();
              _selectedWallet = _wallets.first;
            }

            @override
            void dispose() {
              _amountController.dispose();
              _codeController.dispose();
              super.dispose();
            }

            void _selectMethod(PaymentMethod method) {
              setState(() {
                _method = method;
                _statusText = null;
              });
            }

            Future<void> _onConfirmPressed() async {
              final amountText = _amountController.text.trim();
              if (amountText.isEmpty) {
                setState(() {
                  _statusText = 'لطفاً مبلغ پرداخت را وارد کنید.';
                });
                return;
              }

              final amount =
                  int.tryParse(amountText.replaceAll('٬', '').replaceAll(',', ''));
              if (amount == null || amount <= 0) {
                setState(() {
                  _statusText = 'مبلغ وارد شده نامعتبر است.';
                });
                return;
              }

              final request = PaymentRequest(
                wallet: _selectedWallet,
                amount: amount,
                manualCode: _codeController.text.trim().isEmpty
                    ? null
                    : _codeController.text.trim(),
              );

              if (_method == PaymentMethod.bluetooth) {
                final resultCode = await Navigator.push<String>(
                  context,
                  MaterialPageRoute(
                    builder: (_) => const Directionality(
                      textDirection: TextDirection.rtl,
                      child: SizedBox.shrink(),
                    ),
                  ),
                );

                // این بخش بلافاصله با صفحه واقعی پرداخت بلوتوث جایگزین می‌شود
                // (در ادامه همین فایل تعریف شده است)
              } else {
                setState(() {
                  _statusText =
                      'حالت QR کد در این نسخه‌ی دمو هنوز فعال نشده است.';
                });
              }
            }

            @override
            Widget build(BuildContext context) {
              final methodBluetooth = _method == PaymentMethod.bluetooth;
              final methodQr = _method == PaymentMethod.qr;

              return Scaffold(
                appBar: AppBar(
                  title: const Text('اپ آفلاین سوما'),
                  centerTitle: true,
                ),
                body: Padding(
                  padding: const EdgeInsets.all(16),
                  child: ListView(
                    children: [
                      const Align(
                        alignment: Alignment.centerRight,
                        child: Text(
                          'اپ خریدار',
                          style: TextStyle(
                            fontSize: 16,
                          ),
                        ),
                      ),
                      const SizedBox(height: 12),
                      _buildBalanceCard(),
                      const SizedBox(height: 24),
                      const Text(
                        'انتخاب نحوه پرداخت',
                        style: TextStyle(
                            fontSize: 16, fontWeight: FontWeight.bold),
                      ),
                      const SizedBox(height: 12),
                      FilledButton(
                        onPressed: () => _selectMethod(PaymentMethod.bluetooth),
                        style: FilledButton.styleFrom(
                          minimumSize: const Size.fromHeight(48),
                          backgroundColor: methodBluetooth
                              ? Colors.teal
                              : Colors.teal.shade200,
                        ),
                        child: const Text('پرداخت با بلوتوث'),
                      ),
                      const SizedBox(height: 8),
                      FilledButton.tonal(
                        onPressed: () => _selectMethod(PaymentMethod.qr),
                        style: FilledButton.styleFrom(
                          minimumSize: const Size.fromHeight(48),
                        ),
                        child: const Text('پرداخت با QR کد'),
                      ),
                      const SizedBox(height: 24),
                      const Text(
                        'انتخاب کیف پول برای پرداخت',
                        style: TextStyle(
                            fontSize: 16, fontWeight: FontWeight.bold),
                      ),
                      const SizedBox(height: 12),
                      ..._wallets.map(
                        (w) => Card(
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(16),
                            side: BorderSide(
                              color: w.id == _selectedWallet.id
                                  ? Colors.teal
                                  : Colors.grey.shade300,
                            ),
                          ),
                          child: RadioListTile<String>(
                            value: w.id,
                            groupValue: _selectedWallet.id,
                            onChanged: (value) {
                              if (value == null) return;
                              setState(() => _selectedWallet = w);
                            },
                            title: Text(
                              w.title,
                              style:
                                  const TextStyle(fontWeight: FontWeight.bold),
                            ),
                            subtitle: Text(w.description),
                            activeColor: Colors.teal,
                          ),
                        ),
                      ),
                      const SizedBox(height: 16),
                      const Text(
                        'مبلغ پرداخت (تومان)',
                        style: TextStyle(fontWeight: FontWeight.bold),
                      ),
                      const SizedBox(height: 8),
                      TextField(
                        controller: _amountController,
                        keyboardType: TextInputType.number,
                        decoration: InputDecoration(
                          hintText: 'مثلاً ۲۵۰۰۰ تومان',
                          border: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(16),
                          ),
                        ),
                      ),
                      const SizedBox(height: 16),
                      const Text(
                        'کد تراکنش',
                        style: TextStyle(fontWeight: FontWeight.bold),
                      ),
                      const SizedBox(height: 8),
                      TextField(
                        controller: _codeController,
                        decoration: InputDecoration(
                          hintText: 'کد / شناسه تراکنش (اختیاری)',
                          border: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(16),
                          ),
                        ),
                      ),
                      const SizedBox(height: 16),
                      FilledButton(
                        onPressed: () async {
                          final amountText = _amountController.text.trim();
                          if (amountText.isEmpty) {
                            setState(() {
                              _statusText = 'لطفاً مبلغ پرداخت را وارد کنید.';
                            });
                            return;
                          }

                          final amount = int.tryParse(
                            amountText
                                .replaceAll('٬', '')
                                .replaceAll(',', ''),
                          );
                          if (amount == null || amount <= 0) {
                            setState(() {
                              _statusText = 'مبلغ وارد شده نامعتبر است.';
                            });
                            return;
                          }

                          final request = PaymentRequest(
                            wallet: _selectedWallet,
                            amount: amount,
                            manualCode: _codeController.text.trim().isEmpty
                                ? null
                                : _codeController.text.trim(),
                          );

                          if (_method == PaymentMethod.bluetooth) {
                            final resultCode = await Navigator.push<String>(
                              context,
                              MaterialPageRoute(
                                builder: (_) => Directionality(
                                  textDirection: TextDirection.rtl,
                                  child:
                                      BluetoothPaymentPage(request: request),
                                ),
                              ),
                            );
                            if (resultCode != null) {
                              setState(() {
                                _lastTransactionCode = resultCode;
                                _statusText =
                                    'پرداخت بلوتوث با موفقیت انجام شد.';
                              });
                            }
                          } else {
                            setState(() {
                              _statusText =
                                  'حالت QR کد در این نسخه‌ی دمو هنوز فعال نشده است.';
                            });
                          }
                        },
                        style: FilledButton.styleFrom(
                          minimumSize: const Size.fromHeight(48),
                        ),
                        child: const Text('تأیید و شروع پرداخت'),
                      ),
                      const SizedBox(height: 16),
                      if (_lastTransactionCode != null)
                        Text(
                          'کد تراکنش آخر: $_lastTransactionCode',
                          style: const TextStyle(color: Colors.teal),
                        ),
                      if (_statusText != null) ...[
                        const SizedBox(height: 8),
                        Text(
                          _statusText!,
                          style: const TextStyle(color: Colors.deepOrange),
                        ),
                      ],
                    ],
                  ),
                ),
              );
            }

            Widget _buildBalanceCard() {
              return Container(
                width: double.infinity,
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.teal.shade50,
                  borderRadius: BorderRadius.circular(20),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.end,
                  children: const [
                    Text(
                      'موجودی اصلی',
                      style: TextStyle(fontSize: 16),
                    ),
                    SizedBox(height: 8),
                    Text(
                      '۱۲۰٬۰۰۰ تومان',
                      style: TextStyle(
                        fontSize: 22,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ],
                ),
              );
            }
          }

          enum BluetoothScanStatus {
            preparing,
            scanning,
            noDevices,
            devicesFound,
            connecting,
            connected,
            error,
          }

          class BluetoothPaymentPage extends StatefulWidget {
            final PaymentRequest request;

            const BluetoothPaymentPage({super.key, required this.request});

            @override
            State<BluetoothPaymentPage> createState() =>
                _BluetoothPaymentPageState();
          }

          class _BluetoothPaymentPageState
              extends State<BluetoothPaymentPage> {
            BluetoothScanStatus _status = BluetoothScanStatus.preparing;
            final List<String> _allDemoDevices = const [
              'SOMA-STORE-01',
              'SOMA-STORE-02',
              'SOMA-MARKET-LOCAL',
            ];
            final List<String> _visibleDevices = [];
            String? _selectedDevice;
            String? _connectionMessage;
            String? _generatedCode;

            @override
            void initState() {
              super.initState();
              _startDemoScan();
            }

            void _startDemoScan() {
              setState(() {
                _status = BluetoothScanStatus.scanning;
                _visibleDevices.clear();
                _selectedDevice = null;
                _connectionMessage = null;
                _generatedCode = null;
              });

              Future.delayed(const Duration(seconds: 2), () {
                setState(() {
                  _visibleDevices.addAll(_allDemoDevices);
                  _status = _visibleDevices.isEmpty
                      ? BluetoothScanStatus.noDevices
                      : BluetoothScanStatus.devicesFound;
                  _connectionMessage = _visibleDevices.isEmpty
                      ? 'هیچ دستگاه فروشنده مجاز در نزدیکی یافت نشد.'
                      : 'فروشنده‌های نزدیک یافت شد. لطفاً یکی را انتخاب کنید.';
                });
              });
            }

            String _statusText() {
              switch (_status) {
                case BluetoothScanStatus.preparing:
                  return 'در حال آماده‌سازی بلوتوث…';
                case BluetoothScanStatus.scanning:
                  return 'در حال جست‌وجوی دستگاه‌های فروشنده نزدیک…';
                case BluetoothScanStatus.noDevices:
                  return 'هیچ دستگاه فروشنده مجاز در نزدیکی یافت نشد.';
                case BluetoothScanStatus.devicesFound:
                  return _connectionMessage ?? 'فروشنده‌های نزدیک یافت شد.';
                case BluetoothScanStatus.connecting:
                  return 'در حال اتصال به دستگاه انتخاب‌شده…';
                case BluetoothScanStatus.connected:
                  return 'اتصال با موفقیت برقرار شد.';
                case BluetoothScanStatus.error:
                  return 'خطا در اتصال. لطفاً دوباره تلاش کنید.';
              }
            }

            Future<void> _connectAndPay() async {
              if (_selectedDevice == null) {
                setState(() {
                  _connectionMessage =
                      'لطفاً یک دستگاه فروشنده را انتخاب کنید.';
                });
                return;
              }
              setState(() {
                _status = BluetoothScanStatus.connecting;
                _connectionMessage = null;
              });

              await Future.delayed(const Duration(seconds: 2));

              setState(() {
                _status = BluetoothScanStatus.connected;
                final now = DateTime.now();
                _generatedCode =
                    'SOMA-${now.year % 100}${now.month.toString().padLeft(2, '0')}${now.day.toString().padLeft(2, '0')}-${now.millisecondsSinceEpoch % 1000000}';
                _connectionMessage = 'پرداخت با موفقیت در حالت دمو ثبت شد.';
              });

              await Future.delayed(const Duration(seconds: 1));
              if (!mounted) return;
              Navigator.pop(context, _generatedCode);
            }

            @override
            Widget build(BuildContext context) {
              final req = widget.request;

              return Scaffold(
                appBar: AppBar(
                  title: const Text('پرداخت با بلوتوث (اپ خریدار)'),
                  centerTitle: true,
                ),
                body: Padding(
                  padding: const EdgeInsets.all(16),
                  child: ListView(
                    children: [
                      _buildSummaryCard(req),
                      const SizedBox(height: 24),
                      const Text(
                        'انتخاب دستگاه فروشنده',
                        style: TextStyle(
                            fontSize: 16, fontWeight: FontWeight.bold),
                      ),
                      const SizedBox(height: 12),
                      if (_visibleDevices.isEmpty &&
                          _status == BluetoothScanStatus.scanning)
                        const Center(child: CircularProgressIndicator())
                      else
                        ..._visibleDevices.map(
                          (id) => Card(
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(16),
                            ),
                            child: RadioListTile<String>(
                              value: id,
                              groupValue: _selectedDevice,
                              onChanged: (value) {
                                if (value == null) return;
                                setState(() => _selectedDevice = value);
                              },
                              title: Text(id.replaceAll(
                                  'SOMA-MARKET-LOCAL', 'SOMA - سوپرمارکت محل')),
                              subtitle: const Text('فروشنده نزدیک (دمو)'),
                              activeColor: Colors.teal,
                            ),
                          ),
                        ),
                      const SizedBox(height: 16),
                      const Text(
                        'وضعیت اتصال',
                        style: TextStyle(fontWeight: FontWeight.bold),
                      ),
                      const SizedBox(height: 8),
                      Container(
                        width: double.infinity,
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          borderRadius: BorderRadius.circular(16),
                          border: Border.all(color: Colors.grey.shade300),
                        ),
                        child: Text(_statusText()),
                      ),
                      if (_connectionMessage != null) ...[
                        const SizedBox(height: 8),
                        Text(
                          _connectionMessage!,
                          style: const TextStyle(color: Colors.teal),
                        ),
                      ],
                      const SizedBox(height: 24),
                      OutlinedButton(
                        onPressed: _startDemoScan,
                        style: OutlinedButton.styleFrom(
                          minimumSize: const Size.fromHeight(48),
                        ),
                        child: const Text('جست‌وجوی مجدد'),
                      ),
                      const SizedBox(height: 12),
                      FilledButton(
                        onPressed: _status == BluetoothScanStatus.devicesFound ||
                                _status == BluetoothScanStatus.connected
                            ? _connectAndPay
                            : null,
                        style: FilledButton.styleFrom(
                          minimumSize: const Size.fromHeight(48),
                        ),
                        child: const Text('تأیید و ارسال پرداخت'),
                      ),
                    ],
                  ),
                ),
              );
            }

            Widget _buildSummaryCard(PaymentRequest req) {
              return Container(
                width: double.infinity,
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.teal.shade50,
                  borderRadius: BorderRadius.circular(20),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.end,
                  children: [
                    Text(
                      'کیف پول انتخاب‌شده: ${req.wallet.title}',
                      style: const TextStyle(fontSize: 14),
                    ),
                    const SizedBox(height: 8),
                    Text(
                      'مبلغ پرداخت: ${req.amount} تومان',
                      style: const TextStyle(
                        fontSize: 18,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    if (_generatedCode != null) ...[
                      const SizedBox(height: 8),
                      Text(
                        'کد تراکنش: $_generatedCode',
                        style: const TextStyle(color: Colors.teal),
                      ),
                    ],
                  ],
                ),
              );
            }
          }
          DART

      - name: Build release APK
        working-directory: soma_demo
        run: flutter build apk --release --no-shrink

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: soma_demo_app-release.apk
          path: soma_demo/build/app/outputs/flutter-apk/app-release.apk
